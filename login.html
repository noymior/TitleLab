<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>登录</title>
  <link rel="stylesheet" href="assets/styles.css" />
  <link rel="icon" type="image/png" sizes="192x192" href="icon/icon-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="icon/icon-512.png" />
</head>
<body style="display:flex;align-items:center;justify-content:center;min-height:100vh;background:#f8fafc;">
  <div class="panel" style="width:100%;max-width:360px;">
    <div class="modal-title" style="margin-bottom:10px;">登录</div>
    <label class="field-label">用户名</label>
    <input id="loginUsername" class="field-input" type="text" placeholder="请输入用户名" />
    <div style="height:8px"></div>
    <label class="field-label">密码</label>
    <input id="loginPassword" class="field-input" type="password" placeholder="可留空（仅普通用户）" />
    <div style="height:12px"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button id="btnLogin" class="function-btn">登录</button>
    </div>
    <div id="loginToast" class="hidden" style="margin-top:10px;padding:6px 10px;border-radius:8px;font-size:12px;background:#eef2ff;color:#111827;"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.3/dist/umd/supabase.js"></script>
  <script src="assets/supabase.js"></script>
  <script>
    function showMsg(msg, ok) {
      const el = document.getElementById('loginToast');
      if (!el) return;
      el.textContent = msg;
      el.classList.remove('hidden');
      el.style.background = ok ? '#dcfce7' : '#fee2e2';
      el.style.color = ok ? '#166534' : '#b91c1c';
      setTimeout(() => el.classList.add('hidden'), 1800);
    }

    function getCurrentUser() {
      try { const raw = localStorage.getItem('current_user_v1'); return raw ? JSON.parse(raw) : null; } catch (_) { return null; }
    }

    async function sha256Hex(s) {
      const enc = new TextEncoder();
      const buf = await crypto.subtle.digest('SHA-256', enc.encode(s));
      return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    function userTag(u) { return `user:${u}`; }

    async function recordUserProfile(username, role) {
      try {
        const client = window.supabaseClient;
        if (!client) return;
        const row = { key: `user_profile_${username}`, payload: { username, role, last_login_at: new Date().toISOString() }, updated_at: new Date().toISOString() };
        await client.from('snapshots').upsert([row], { onConflict: 'key' });
      } catch (_) { /* ignore */ }
    }

    document.getElementById('btnLogin').addEventListener('click', async () => {
      const u = document.getElementById('loginUsername').value.trim();
      const p = document.getElementById('loginPassword').value || '';
      if (!u) { showMsg('请输入用户名', false); return; }

      let role = 'user';
      let needPwd = false;
      if (u === 'sevenoy') { role = 'admin'; needPwd = true; }
      if (u === 'olina') { role = 'user'; needPwd = true; }
      if (needPwd && p !== 'jiajia') { showMsg('密码错误', false); return; }

      const profile = { username: u, role };
      localStorage.setItem('current_user_v1', JSON.stringify(profile));
      try { await recordUserProfile(u, role); } catch (_) {}
      showMsg('登录成功', true);
      setTimeout(() => { window.location.href = 'title.html'; }, 400);
    });
  </script>
</body>
</html>